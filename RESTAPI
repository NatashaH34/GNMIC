import subprocess
import socket

SUCCESS = "NOERROR"

class RESTAPI:
  """
  REST API handle
  Supports logging into the node and connecting to the node
  """

  # Login to the node

  def login(self):
    """
    Login to the node from collector
    Parse status information and log output
    Returns: True if successful, False if unsuccessful
    """
    loginCMD = f"/opt/tools/swtools/6500/nbitools/testrest login {self.device.sp_ip_address}"

    process = subprocess.run(
      loginCMD,
      stdout=subprocess.PIPE,
      stderr=subprocess.PIPE,
      shell=True,
      universal_newlines=True,
    )

    self.log.debug(process.stdout)

    if SUCCESS not in process.stdout:
      self.log.error("Login unsuccessful")
      if process.stderr:
        self.log.error(process.stderr)
      return False

    self.log.info("Login successful")
    return True

  # Config on the node:

  def createTargetID(self):
    """
    Create a target-id of custom type
    Parse status information and log output
    Returns: True if successful, False if unsuccessful
    """
    targetidCMD = "/opt/tools/swtools/6500/nbitools/testrest put " \
                  "api/v1/datastore/grpc-tunnel/target-id/target_id_project_alpha '{\"components\":[\"custom\"]," \
                  "\"custom\":\"TARGET_ID_PROJECT_ALPHA\"}\'"

    process = subprocess.run(
      targetidCMD,
      stdout=subprocess.PIPE,
      stderr=subprocess.PIPE,
      shell=True,
      universal_newlines=True,
    )
    
    self.log.debug(process.stdout)

    if SUCCESS not in process.stdout:
      self.log.error("Target-id could not be created")
      if process.stderr:
        self.log.error(process.stderr)
      return False

    self.log.info("Target-id created successfully")
    return True

  def createDestination(self, tunnel="insecure", address="50066"):
    """
    Use the target-id to create a destination
    Parse status information and log output
    Returns: True if successful, False if unsuccessful
    Args:
      tunnel: either secure or insecure (string)
      address: port number (string)
    """

    tunnel_secure = "true" if tunnel == "secure" else "false"

    createDestCMD = f"/opt/tools/swtools/6500/nbitools/testrest put api/v1/datastore/grpc-tunnel/destination/" \
                    f"{socket.gethostbyname(socket.gethostname())},{address}/ " \
                    f"'{{\"address\":{socket.gethostbyname(socket.gethostname())}," \
                    f"\"port\":{address},\"description\":\"Dialout1\",\"admin-state\":\"enable\"," \
                    f"\"secure-tunnel\":{tunnel_secure},\"handler\":[{{\"target-id\":\"target_id_project_alpha\"," \
                    f"\"target-type\":\"GNMI_GNOI\",\"secure-service\":\"true\"}}]}}'"

    process = subprocess.run(
      createDestCMD,
      stdout=subprocess.PIPE,
      stderr=subprocess.PIPE,
      shell=True,
      universal_newlines=True,
    )

    self.log.debug(process.stdout)

    if SUCCESS not in process.stdout:
      self.log.error("Destination could not be created")
      if process.stderr:
        self.log.error(process.stderr)
      return False

    self.log.info("Destination created successfully")
    return True
